<!-- HTML header for doxygen 1.8.6-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<link href='http://fonts.googleapis.com/css?family=Open+Sans:400,600' rel='stylesheet' type='text/css'>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.8"/>
<title>Imperial Analysis: Analysis Build System</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="customdoxygen2.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 70px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Imperial Analysis
   </div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.8 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('build-system.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Analysis Build System </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#build-system-folders">Folder Structure </a></li>
<li class="level1"><a href="#build-system-rules-mk">The Rules.mk file  </a></li>
<li class="level1"><a href="#build-system-invoke">Invoking make </a></li>
<li class="level1"><a href="#build-system-external">External libraries </a></li>
<li class="level1"><a href="#build-system-no-cmssw">Compile without CMSSW </a></li>
<li class="level1"><a href="#build-system-dict">Generate ROOT dictionaries </a></li>
</ul>
</div>
<div class="textblock"><p>This page documents the build system for compiling the offline analysis code as well as the folder structure this system expects. Much like the CMSSW framework, code under the <b>Analysis</b> folder is arranged into packages, with each package grouping together a related set of classes, programs and scripts. For example, the <b>Core</b> folder contains the basic classes for building an analysis and plotting the results, whereas the <b>HiggsTauTau</b> folder contains the code specific to the Higgs to taus analysis.</p>
<p>Code in the <b>Analysis</b> folder can be thought of as separate from the <b>ICHiggsTauTau</b> CMSSW package, and indeed is ignored by the <code>scram</code> tool. Instead we use <code>make</code> to resolve dependencies between the different analysis packages and to compile the code. In the past, a separate makefile was provided in each package sub-directory which would have hard-coded calls to the makefiles of other packages which are dependencies. This so-called recursive make system had a number of issues, in particular the need to maintain several makefiles containing mostly repeated content and the recompilation of large amounts of code triggered by any change in other packages. See <a href="http://aegis.sourceforge.net/auug97.pdf">this</a> page for a detailed discussion of the problems with recursive make. Instead a single makefile is used and which has a global awareness of code in all packages and can efficiently resolve the dependencies whilst still allowing for single packages to to be compiled. This was derived from the example system <a href="https://github.com/aostruszka/nonrec-make">here</a>.</p>
<h1><a class="anchor" id="build-system-folders"></a>
Folder Structure </h1>
<p>Each package must contain, at the minimum, the following files and folders: </p><pre class="fragment">makefile
Rules.mk
interface/
src/
obj/
lib/
test/
bin/
</pre><p>The <code>makefile</code> should just be a symbolic link the file in <code>Analysis/mk/makefile</code>. The file <code>Rules.mk</code> is a makefile fragment and defines just a few variables to guide the build system in this package. If you are setting up a new package you can just do: </p><pre class="fragment">mkdir [package]
cd [package]
ln -s ../mk/makefile ./
cp ../Rules.mk ./  # copy the top-level Rules.mk to use as a template
mkdir interface src obj lib test bin
</pre><p>Class definition and implementation files should be placed in the <code>interface</code> and <code>src</code> directories respectively. Each file in the <code>src</code> should have the extension .cc* and will be compiled to a corresponding object file in the <code>obj</code> directory. All object files are then combined into a shared library which will reside in the <code>lib</code> directory, and will have the name of the containing folder prefixed with libIC, e.g. <code>libICCore.so</code> is the library name in the <b>Core</b> package. The source code for executable programs goes in the <code>test</code> directories with the extension .cpp. Each of these files will be compiled to an executable in the <code>bin</code> directory and linked against the shared library in the process.</p>
<h1><a class="anchor" id="build-system-rules-mk"></a>
The Rules.mk file  </h1>
<p>A file named <code>Rules.mk</code> must be placed in each directory to tell the build system that it contains code to be compiled. This file should define three variables, some or all of which may be empty. This is an example from the <b>HiggsTauTau</b> package: </p><pre class="fragment">SUBDIRS   :=
LIB_DEPS  := Core Utilities Modules
LIB_EXTRA := -lCondFormatsJetMETObjects
</pre><p>SUBDIRS is a space separated list of the any sub-directories that also define a package, it tells make to enter each directory in turn, look for a <code>Rules.mk</code> file and apply the compile rules outlined above. In this case it's empty as <b>HiggsTauTau</b> does not contain any additional packages. LIB_DEPS lists the packages that this one depends on, i.e. which other shared libraries need to be built first and then linked against the shared library and executables defined here. In this example the <b>Core</b>, <b>Utilities</b> and <b>Modules</b> shared libraries are marked as dependencies. LIB_EXTRA is a string that will added as an argument when the <code>g++</code> compiler is invoked and will typically be used to link code against additional external libraries (a number of external libraries are linked by default, see below).</p>
<p>When <code>make</code> is invoked it will first look for a <code>Rules.top</code> file, which has the same structure as a <code>Rules.mk</code> file and is used to identify the top directory where sub-directory scanning should start. It will first look in the current directory then repeatedly change to the enclosing directory until this file is found, which in this case in the <b>Analysis</b> folder. The <code>Rules.top</code> file here only needs to define the sub-directories to be scanned, and you should add the name of any new packages to this list. Each named directory is then scanned for compile targets by looking for files with the appropriate extensions in the <code>src</code> and <code>test</code> directories.</p>
<h1><a class="anchor" id="build-system-invoke"></a>
Invoking make </h1>
<p>The makefile defines a number of special targets that can be built by running: <code>make [target]</code></p>
<ul>
<li><code>make dir</code> or just <code>make</code>: Only compile the code in the current directory, including the minimum set of dependencies in other packages if necessary.</li>
<li><code>make tree</code>: Compile the code in the current directory, and recursively into all sub-directories starting from this one (as defined in each <code>Rules.mk</code> file)</li>
<li><code>make all</code>: Compile every package recursively starting from the top directory</li>
<li><code>make clean</code>: Removes every file in the <code>bin</code>, <code>obj</code> and <code>lib</code> directories in the current package</li>
<li><code>make clean_tree</code>: Also cleans packages in sub-directories</li>
<li><code>make clean_all</code>: Clean every package recursively starting from the top directory</li>
<li><code>make bin/[program]</code> Shortcut target for each executable in the current directory. This provides a quick way to update a single program.</li>
</ul>
<p>On machines with multiple processor cores add the <code>-j[n]</code> option to compile with <em>n</em> threads. By default the makefile will just print a summary of each operation to the screen. To print the full command for each step add the option <code>V=1</code>. The option <code>DEBUG=1</code> can also be added which will cause make to print a list of the targets it finds as it scans directories.</p>
<h1><a class="anchor" id="build-system-external"></a>
External libraries </h1>
<p>A number of header file search paths are defined in the makefile, and several external libraries will be linked by default:</p>
<ul>
<li>ROOT: The version of ROOT that ships with the CMSSW version you are using will be searched for header files and the common libraries linked. ROOT header files can be included directly in Analysis code, e.g.<pre class="fragment">#include "TFile.h" </pre></li>
<li>ROOFIT: As for ROOT, ROOFIT headers can be included directly, e.g.<pre class="fragment">#include "RooRealVar.h" </pre></li>
<li>boost: The C++ <a href="http://www.boost.org">boost</a> libraries may also be used. These provide a large range of useful extensions to the core C++ libraries. Most boost libraries are header-only, meaning there is no shared library to link against. A few commonly used exceptions to this are the <code>filesystem</code>, <code>regex</code> and <code>program_options</code> libraries, and these will be linked by default. If your package requires linking to additional boost shared libraries these can be added to the LIB_EXTRA variable in the <code>Rules.mk</code> file</li>
<li>CMSSW: Files can be included relative to the CMSSW <code>src</code> directory, e.g.<pre class="fragment">#include "PhysicsTools/FWLite/interface/TFileService.h" </pre> Both the local CMSSW area and the base release will be searched. CMSSW libraries <code>libFWCoreFWLite</code> and <code>libPhysicsToolsFWLite</code> are linked by default as these are needed to load custom object classes stored in TTrees. The library <code>libUserCodeICHiggsTauTau</code> is also linked which contains the class definitions defined in the <code>Usercode/ICHiggsTauTau</code> package.</li>
</ul>
<h1><a class="anchor" id="build-system-no-cmssw"></a>
Compile without CMSSW </h1>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000004">Todo:</a></b></dt><dd>Write instructions for CMSSW-less make</dd></dl>
<h1><a class="anchor" id="build-system-dict"></a>
Generate ROOT dictionaries </h1>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000005">Todo:</a></b></dt><dd>Write instructions for generating ROOT dictionaries</dd></dl>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.6-->
<!-- start footer part -->
</body>
</html>
