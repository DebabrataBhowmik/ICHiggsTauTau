<!-- HTML header for doxygen 1.8.6-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<link href='http://fonts.googleapis.com/css?family=Open+Sans:400,600' rel='stylesheet' type='text/css'>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.8"/>
<title>Imperial Analysis: docs/BuildSystem.md Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="customdoxygen2.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 70px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Imperial Analysis
   </div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.8 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('_build_system_8md.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">docs/BuildSystem.md</div>  </div>
</div><!--header-->
<div class="contents">
<a href="_build_system_8md.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;Analysis Build System {#build-system}</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;=====================================</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;</div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;[TOC]</div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;</div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;This page documents the build system for compiling the offline analysis code as well as the folder structure this system expects. Much like the CMSSW framework, code under the **Analysis** folder is arranged into packages, with each package grouping together a related set of classes, programs and scripts. For example, the **Core** folder contains the basic classes for building an analysis and plotting the results, whereas the **HiggsTauTau** folder contains the code specific to the Higgs to taus analysis.</div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;</div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;Code in the **Analysis** folder can be thought of as separate from the **ICHiggsTauTau** CMSSW package, and indeed is ignored by the `scram` tool. Instead we use  `make` to resolve dependencies between the different analysis packages and to compile the code. In the past, a separate makefile was provided in each package sub-directory which would have hard-coded calls to the makefiles of other packages which are dependencies. This so-called recursive make system had a number of issues, in particular the need to maintain several makefiles containing mostly repeated content and the recompilation of large amounts of code triggered by any change in other packages. See [this](http://aegis.sourceforge.net/auug97.pdf) page for a detailed discussion of the problems with recursive make. Instead a single makefile is used and which has a global awareness of code in all packages and can efficiently resolve the dependencies whilst still allowing for single packages to to be compiled. This was derived from the example system [here](https://github.com/aostruszka/nonrec-make).</div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;</div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;Folder Structure {#build-system-folders}</div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;========================================</div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;</div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;Each package must contain, at the minimum, the following files and folders:</div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;</div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;   makefile</div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;   Rules.mk</div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;   interface/</div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;   src/</div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;   obj/</div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;   lib/</div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;   test/</div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;   bin/</div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;</div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;The `makefile` should just be a symbolic link the file in `Analysis/mk/makefile`. The file `Rules.mk` is a makefile fragment and defines just a few variables to guide the build system in this package.  If you are setting up a new package you can just do:</div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;</div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;   mkdir [package]</div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;   cd [package]</div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;   ln -s ../mk/makefile ./</div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;   cp ../Rules.mk ./  # copy the top-level Rules.mk to use as a template</div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;   mkdir interface src obj lib test bin</div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;</div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;Class definition and implementation files should be placed in the `interface` and `src` directories respectively. Each file in the `src` should have the extension .cc* and will be compiled to a corresponding object file in the `obj` directory.  All object files are then combined into a shared library which will reside in the `lib` directory, and will have the name of the containing folder prefixed with libIC, e.g. `libICCore.so` is the library name in the **Core** package. The source code for executable programs goes in the `test` directories with the extension .cpp. Each of these files will be compiled to an executable in the `bin` directory and linked against the shared library in the process.</div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;</div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;The Rules.mk file  {#build-system-rules-mk}</div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;=================</div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;A file named `Rules.mk` must be placed in each directory to tell the build system that it contains code to be compiled. This file should define three variables, some or all of which may be empty. This is an example from the **HiggsTauTau** package:</div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;</div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;   SUBDIRS   :=</div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;   LIB_DEPS  := Core Utilities Modules</div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;   LIB_EXTRA := -lCondFormatsJetMETObjects</div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;</div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;SUBDIRS is a space separated list of the any sub-directories that also define a package, it tells make to enter each directory in turn, look for a `Rules.mk` file and apply the compile rules outlined above. In this case it&#39;s empty as **HiggsTauTau** does not contain any additional packages. LIB_DEPS lists the packages that this one depends on, i.e. which other shared libraries need to be built first and then linked against the shared library and executables defined here. In this example the **Core**, **Utilities** and **Modules** shared libraries are marked as dependencies. LIB_EXTRA is a string that will added as an argument when the `g++` compiler is invoked and will typically be used to link code against additional external libraries (a number of external libraries are linked by default, see below).</div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;</div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;When `make` is invoked it will first look for a `Rules.top` file, which has the same structure as a `Rules.mk` file and is used to identify the top directory where sub-directory scanning should start. It will first look in the current directory then repeatedly change to the enclosing directory until this file is found, which in this case in the **Analysis** folder. The `Rules.top` file here only needs to define the sub-directories to be scanned, and you should add the name of any new packages to this list. Each named directory is then scanned for compile targets by looking for files with the appropriate extensions in the `src` and `test` directories.</div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;</div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;Invoking make {#build-system-invoke}</div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;=============</div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;</div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;The makefile defines a number of special targets that can be built by running: `make [target]`</div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;</div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160; * `make dir` or just `make`: Only compile the code in the current directory, including the minimum set of dependencies in other packages if necessary.</div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160; * `make tree`: Compile the code in the current directory, and recursively into all sub-directories starting from this one (as defined in each `Rules.mk` file)</div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160; * `make all`: Compile every package recursively starting from the top directory</div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160; * `make clean`: Removes every file in the `bin`, `obj` and `lib` directories in the current package</div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160; * `make clean_tree`: Also cleans packages in sub-directories</div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160; * `make clean_all`: Clean every package recursively starting from the top directory</div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160; * `make bin/[program]` Shortcut target for each executable in the current directory. This provides a quick way to update a single program.</div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;</div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160; On machines with multiple processor cores add the `-j[n]` option to compile with *n* threads. By default the makefile will just print a summary of each operation to the screen. To print the full command for each step add the option `V=1`. The option `DEBUG=1` can also be added which will cause make to print a list of the targets it finds as it scans directories.</div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;</div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;</div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;External libraries {#build-system-external}</div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;==================</div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;</div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;A number of header file search paths are defined in the makefile, and several external libraries will be linked by default:</div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;</div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160; * ROOT: The version of ROOT that ships with the CMSSW version you are using will be searched for header files and the common libraries linked. ROOT header files can be included directly in Analysis code, e.g. \verbatim #include &quot;TFile.h&quot; \endverbatim</div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160; * ROOFIT: As for ROOT, ROOFIT headers can be included directly, e.g.  \verbatim #include &quot;RooRealVar.h&quot; \endverbatim</div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160; * boost: The C++ [boost](http://www.boost.org) libraries may also be used. These provide a large range of useful extensions to the core C++ libraries. Most boost libraries are header-only, meaning there is no shared library to link against. A few commonly used exceptions to this are the `filesystem`, `regex` and `program_options` libraries, and these will be linked by default. If your package requires linking to additional boost shared libraries these can be added to the LIB_EXTRA variable in the `Rules.mk` file</div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160; * CMSSW: Files can be included relative to the CMSSW `src` directory, e.g. \verbatim #include &quot;PhysicsTools/FWLite/interface/TFileService.h&quot; \endverbatim Both the local CMSSW area and the base release will be searched. CMSSW libraries `libFWCoreFWLite` and `libPhysicsToolsFWLite` are linked by default as these are needed to load custom object classes stored in TTrees. The library `libUserCodeICHiggsTauTau` is also linked which contains the class definitions defined in the `Usercode/ICHiggsTauTau` package.</div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;</div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;Compile without CMSSW {#build-system-no-cmssw}</div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;==============================================</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;</div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;\todo Write instructions for CMSSW-less make</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;</div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;Generate ROOT dictionaries {#build-system-dict}</div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;===============================================</div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;</div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;\todo Write instructions for generating ROOT dictionaries</div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;</div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.6-->
<!-- start footer part -->
</body>
</html>
